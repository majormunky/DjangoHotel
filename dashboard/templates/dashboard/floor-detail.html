{% extends 'dashboard-base.html' %}
{% load static %}

{% block page_name %}Floor Detail{% endblock %}

{% block content %}
<div class="row">
	<div class="col-sm-6">
		<div class="card">
			<div class="card-header fw-bold text-white bg-secondary">
				Floor Details
			</div>
			<div class="card-body">
				<div class="mb-3">
					<div class="fw-bold">Floor Number:</div>
					<div>{{floor_data.number}}</div>
				</div>
				<div>
					<div class="fw-bold">Rooms:</div>
					<div>{{floor_data.room_set.count}}</div>
				</div>
			</div>
		</div>
	</div>
	<div class="col-sm-6">
		<div class="card">
			<div class="card-header fw-bold text-white bg-secondary">
				Rooms
			</div>
			<div class="card-body">
				{% if floor_data.room_set.all %}
					<table class="table" id="room-table">
						<thead>
							<tr>
								<th>&nbsp;</th>
								<th>Room #</th>
								<th>Size</th>
								<th>Beds</th>
							</tr>
						</thead>
						<tbody class="align-middle">
							{% for room in floor_data.room_set.all %}
								<tr>
									<td><a href="{% url 'dashboard-room-detail' room.id %}" class="btn btn-primary btn-sm">View</a></td>
									<td>{{room.number}}</td>
									<td>{{room.get_size_display}}</td>
									<td>{{room.bed_count}}</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				{% else %}
					<p class="card-text">No rooms found for this floor</p>
				{% endif %}
			</div>
			<div class="card-footer">
				<button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#add-room-modal">Add Room</button>
			</div>
		</div>
	</div>
</div>

<div class="modal fade" tabindex="-1" id="add-room-modal">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Add Room</h5>
        		<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      		</div>
      		<div class="modal-body">
        		<div class="mb-3">
        			<label class="form-label">Room Number:</label>
        			<input type="text" class="form-control" id="add-room-number">
        		</div>
        		<div class="mb-3">
        			<label class="form-label">Size:</label>
        			<select class="form-select" id="add-room-size">
        				<option>...</option>
        				{% for size in room_size_choices %}
        					<option value="{{size.0}}">{{size.1}}</option>
        				{% endfor %}
        			</select>
        		</div>
        		<div class="card-text fst-italic">Note: After creating the room you can setup the beds.</div>
        		<div class="fw-bold text-danger" id="add-room-errors"></div>
      		</div>
      		<div class="modal-footer">
        		<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        		<button type="button" class="btn btn-primary" id="add-room-modal-save-button">Save changes</button>
      		</div>
    	</div>
  	</div>
</div>

<template id="room-row-template">
	<tr>
		<td><a href="#" class="btn btn-primary btn-sm add-room-link">View</a></td>
		<td class="add-room-number">{{room.number}}</td>
		<td class="add-room-size">{{room.get_size_display}}</td>
		<td class="add-room-bed-count">{{room.bed_count}}</td>
	</tr>
</template>

{% endblock %}

{% block page_scripts %}
<script src="{% static 'js/ajax.js' %}"></script>
<script>
	const floor_id = "{{floor_data.id}}";
	const csrf_token = "{{csrf_token}}";
	const add_room_modal = new bootstrap.Modal(document.getElementById("add-room-modal"));


	document.getElementById("add-room-modal-save-button").addEventListener("click", async (event) => {
		const data = {
			"room-number": document.getElementById("add-room-number").value,
			"room-size": document.getElementById("add-room-size").value,
			"floor-id": floor_id
		}
		const url = "{% url 'rooms-ajax-create-room' %}";
		const response = await postData(url, csrf_token, data);
		console.log(response)
		if (response.result == "success") {
			const row_template_el = document.getElementById("room-row-template");
			const row_template = row_template_el.content.firstElementChild.cloneNode(true);

			row_template.querySelector(".add-room-link").href = response.data.url;
			row_template.querySelector(".add-room-number").innerHTML = data["room-number"];
			row_template.querySelector(".add-room-size").innerHTML = data["room-size"];
			row_template.querySelector(".add-room-bed-count").innerHTML = "0";

			document.getElementById("room-table").querySelector("tbody").appendChild(row_template);

			add_room_modal.hide();
		} else {
			document.getElementById("add-room-errors").innerHTML = response.message;
		}
	});
</script>
{% endblock %}

{% block page_styles %}
{% endblock %}
